{"version":3,"file":"chatdetail.js","sources":["pages/chatdetail/chatdetail.vue","../../../../../../ProgramFiles/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdGRldGFpbC9jaGF0ZGV0YWlsLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"chat-container\">\n    <!-- 头部 -->\n    <view class=\"chat-header\">\n      <uni-icons type=\"arrowleft\" size=\"24\" color=\"#333\" @click=\"goBack\" class=\"back-icon\"></uni-icons>\n      <text class=\"user-name\">{{ userName }}</text>\n    </view>\n\n    <!-- 消息列表 -->\n    <scroll-view class=\"message-list\" scroll-y :scroll-top=\"scrollTop\" :style=\"{ height: scrollHeight + 'px' }\">\n      <view v-for=\"(message, index) in messages\" :key=\"index\" class=\"message-item\" :class=\"message.sender === myId ? 'me' : 'other'\">\n        <view class=\"message-bubble\">\n          <text class=\"message-text\">{{ message.content }}</text>\n          <text class=\"message-time\">{{ formatTime(message.time) }}</text>\n        </view>\n      </view>\n    </scroll-view>\n\n    <!-- 输入区 -->\n    <view class=\"chat-input-area\">\n      <input v-model=\"newMessage\" type=\"text\" placeholder=\"请输入消息\" :adjust-position=\"false\" @confirm=\"sendMessage\" class=\"message-input\" />\n      <button @click=\"sendMessage\" :disabled=\"!newMessage.trim()\" class=\"send-button\">发送</button>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport {ref, reactive, onMounted, nextTick} from 'vue'\nimport {onLoad} from '@dcloudio/uni-app'\nimport request from '@/api/request' // 需提前封装好 request 方法\n\nconst messages = reactive([])\nconst newMessage = ref('')\nconst scrollTop = ref(0)\nconst scrollHeight = ref(0)\n\nconst myId = ref('')\nconst options = ref({})\nconst userName = ref('')\n\nonLoad(async (params) => {\n  options.value = params\n  console.log('myId set to:', params.value)\n  userName.value = params.userName || '用户'\n  const userInfo = uni.getStorageSync('userInfo')\n  myId.value = userInfo?.openId || 'unknown_user'\n  console.log('myId set to:', myId.value)\n  await loadMessages()\n  setTimeout(() => {\n    calcScrollHeight()\n  }, 300)\n})\n\n// 获取聊天历史\nconst loadMessages = async () => {\n  try {\n    const res = await request({\n      url: '/user/listMessage',\n      method: 'POST',\n      data: {\n        senderId: myId.value,\n        receiverId: options.value.sellerId\n      }\n    })\n    console.log(\"options.value.sellerId----------->\", JSON.stringify(options, null, 2));\n    if (res.code === 200 && res.data) {\n      messages.splice(0, messages.length, ...res.data.map(msg => ({\n        sender: msg.senderId,\n        content: msg.messageContent,\n        time: msg.timestamp || new Date()\n      })))\n      scrollToBottom()\n    }\n  } catch (err) {\n    console.error('加载消息失败', err)\n  }\n}\n\n// 发送消息\nconst sendMessage = async () => {\n  const content = newMessage.value.trim()\n  if (!content) return\n  const msg = {\n    sender: myId.value,\n    content,\n    time: new Date()\n  }\n  messages.push(msg)\n  newMessage.value = ''\n  scrollToBottom()\n  try {\n    const res=await request({\n      url: '/user/sendMessage',\n      method: 'POST',\n      data: {\n        senderId: myId.value,\n        receiverId: options.value.sellerId,\n        messageContent: content\n      }\n    })\n    console.error('sendMessage---------->', res)\n  } catch (err) {\n    console.error('发送失败', err)\n    uni.showToast({title: '消息发送失败', icon: 'none'})\n  }\n}\n\n// 滚动到底部\nconst scrollToBottom = () => {\n  nextTick(() => {\n    scrollTop.value = 999999\n  })\n}\n\n// 时间格式化\nconst formatTime = (date) => {\n  if (!date) return ''\n  const d = new Date(date)\n  return d.toLocaleTimeString('zh', {hour: '2-digit', minute: '2-digit'})\n}\n\n// 高度计算\nconst calcScrollHeight = () => {\n  nextTick(() => {\n    const systemInfo = uni.getSystemInfoSync()\n    const query = uni.createSelectorQuery()\n    query.select('.chat-header').boundingClientRect()\n    query.select('.chat-input-area').boundingClientRect()\n    query.exec(res => {\n      if (res && res[0] && res[1]) {\n        const headerHeight = res[0].height || 50\n        const inputHeight = res[1].height || 60\n        scrollHeight.value = systemInfo.windowHeight - headerHeight - inputHeight\n      } else {\n        // 默认值，防止计算失败\n        scrollHeight.value = systemInfo.windowHeight - 110 // 50(header) + 60(input)\n      }\n    })\n  })\n}\n\n// 返回\nconst goBack = () => {\n  uni.navigateBack()\n}\n</script>\n\n<style lang=\"scss\">\n.chat-container {\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  background-color: #f5f5f5;\n}\n\n.chat-header {\n  display: flex;\n  align-items: center;\n  padding: 15px;\n  background-color: #fff;\n  border-bottom: 1px solid #eee;\n\n  .back-icon {\n    margin-right: 10px;\n  }\n\n  .user-name {\n    font-size: 18px;\n    font-weight: 600;\n    color: #333;\n  }\n}\n\n.message-list {\n  flex: 1;\n  padding: 10px 15px;\n  box-sizing: border-box;\n  background-color: #f5f5f5;\n}\n\n.message-item {\n  margin-bottom: 15px;\n\n  &.me {\n    display: flex;\n    justify-content: flex-end;\n\n    .message-bubble {\n      background-color: #1d9bf0;\n      border-top-right-radius: 0;\n\n      .message-text {\n        color: #fff;\n      }\n\n      .message-time {\n        color: rgba(255, 255, 255, 0.7);\n      }\n    }\n  }\n\n  &.other {\n    display: flex;\n    justify-content: flex-start;\n\n    .message-bubble {\n      background-color: #fff;\n      border-top-left-radius: 0;\n      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n    }\n  }\n}\n\n.message-bubble {\n  max-width: 70%;\n  padding: 10px 12px;\n  border-radius: 8px;\n}\n\n.message-text {\n  font-size: 16px;\n  line-height: 1.4;\n}\n\n.message-time {\n  display: block;\n  font-size: 12px;\n  margin-top: 4px;\n  text-align: right;\n  color: #999;\n}\n\n.chat-input-area {\n  display: flex;\n  padding: 10px;\n  background-color: #fff;\n  border-top: 1px solid #eee;\n\n  .message-input {\n    flex: 1;\n    padding: 8px 12px;\n    background-color: #f5f5f5;\n    border-radius: 20px;\n    margin-right: 10px;\n    font-size: 16px;\n  }\n\n  .send-button {\n    background-color: #1d9bf0;\n    color: #fff;\n    border: none;\n    border-radius: 20px;\n    padding: 0 20px;\n    font-size: 14px;\n\n    &:disabled {\n      background-color: #ccc;\n      color: #999;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from 'D:/作业/软件工程/课程设计/campustrade/code/campustrade-front/pages/chatdetail/chatdetail.vue'\nwx.createPage(MiniProgramPage)"],"names":["reactive","ref","onLoad","uni","request","nextTick","MiniProgramPage"],"mappings":"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"}